# Chirpy

Chirpy is a Twitter-like RESTful API server written in Go, designed for learning and rapid prototyping. It supports user registration, authentication, posting short messages ("chirps"), and basic admin operations. The backend uses PostgreSQL and features JWT authentication, refresh tokens, and a simple web frontend.

## Features

-   User registration and login with Argon2id password hashing
-   JWT-based authentication for protected endpoints
-   Refresh token support for session management
-   CRUD operations for "chirps" (short messages)
-   Admin endpoints for metrics and user reset (development only)
-   Webhook endpoint for upgrading users to "Chirpy Red"
-   Static web frontend served from `/web`
-   Environment-based configuration via `.env`

## Project Structure

```
cmd/chirpy/           # Main application entrypoint
internal/
  auth/               # Authentication and JWT logic
  config/             # API configuration and middleware
  database/           # Database connection and access
  handlers/           # HTTP handlers (API and web)
  storage/            # Data access layer (users, chirps, tokens)
  types/              # Shared types and models
  util/               # Utility functions (JSON responses, etc.)
pkg/
  utils/              # Helper utilities (e.g., SafeClose)
sql/
  schema/             # Database schema migrations
  queries/            # SQL queries for sqlc codegen
web/                  # Static web assets
```

## Getting Started

### Prerequisites

-   Go 1.24+
-   PostgreSQL database
-   [sqlc](https://sqlc.dev/) (optional, for regenerating database code)

### Setup

1. **Clone the repository**

    ```sh
    git clone https://github.com/leonlonsdale/chirpy.git
    cd chirpy
    ```

2. **Configure environment variables**

    Copy `env.example` to `.env` and fill in your values:

    ```
    ADDR=":8080"
    DB_URL="postgres://user:password@localhost:5432/chirpy?sslmode=disable"
    PLATFORM="dev"
    JWT_SECRET_KEY="your_jwt_secret"
    POLKA_KEY="your_polka_webhook_key"
    ```

3. **Run database migrations**

    Apply migrations in `sql/schema/` using [goose](https://github.com/pressly/goose) or your preferred tool:

    ```sh
    goose postgres "$DB_URL" up
    ```

4. **Build and run the server**

    ```sh
    go run ./cmd/chirpy
    ```

    The server listens on the port specified by `ADDR` (default `:8080`).

## API Endpoints

### User Endpoints

-   `POST /api/users` — Register a new user
-   `PUT /api/users` — Update user email/password (requires JWT)

### Authentication

-   `POST /api/login` — Login and receive JWT + refresh token
-   `POST /api/refresh` — Exchange refresh token for new JWT
-   `POST /api/revoke` — Revoke a refresh token

### Chirps

-   `POST /api/chirps` — Create a new chirp (requires JWT)
-   `GET /api/chirps` — List all chirps (optional `author_id` and `sort=asc|desc`)
-   `GET /api/chirps/{chirpID}` — Get a specific chirp by ID
-   `DELETE /api/chirps/{chirpID}` — Delete a chirp (requires JWT, must be author)

### Admin & Web

-   `GET /admin/metrics` — View server metrics (development only)
-   `POST /admin/reset` — Reset user data and metrics (development only)
-   `POST /api/polka/webhooks` — Webhook to upgrade user to Chirpy Red (requires API key)

### Static Files

-   `/app/` — Serves static files from the `web/` directory

## Development Notes

-   Handlers are in [`internal/handlers`](internal/handlers/).
-   Database queries are generated by [`sqlc`](https://sqlc.dev/) from [`sql/queries`](sql/queries/).
-   Authentication logic is in [`internal/auth`](internal/auth/).
-   Configuration and middleware are in [`internal/config`](internal/config/).
-   Utility functions are in [`internal/util`](internal/util/) and [`pkg/utils`](pkg/utils/).

## Testing

Run all tests with:

```sh
go test ./...
```

## License

MIT License.
